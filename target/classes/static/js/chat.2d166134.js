(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chat"],{"002d":function(e,t,s){},"03a8":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAqCAYAAAD1T9h6AAAABHNCSVQICAgIfAhkiAAAAVlJREFUWEfV2c1Nw0AQQOGXAhCUkBLoAOgESsiFHuggR1JBOHIDUQEUgEQJHDhyiCayI8da/86sd8b3jN+3q0ReZ4XtdQXsgQ3waTs6PW1leBOJfwOugV/gbgmEFaAZX6/JIggLQCpeEF/AbbUbhht9PkoLKBovFA2geLwG4CJ+LsBN/ByAq/ipAHfxUwAu48cC3MaPAbiOHwK4j+8DhIjvAoSJTwFCxbcB4eKbgJDxNaAr/q86Uf1ne5jXD97K4/Q7cKOfVWTCowDkDCuIyyIJupseAXJFRZwANeIDuGgtyhPwqluobJ/+bh8pu3biAXjOlqEYnDoTh0J0HerDIPreSoRADL1WcY8YAvT9xLr4Yo8BuEaMBbhFTAG4REwFuEPMAbhCzAW4QWgALhBaQHGEBaAPIX/0yWEp22UFSCF2wH228mqwJaCJeFkiXm5oDZCZa+An98rX8w+YCmb+NJKbQwAAAABJRU5ErkJggg=="},"293a":function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"home"},[a("div",{staticClass:"home-body"},[a("div",{staticClass:"home-right"},[a("div",{staticClass:"chat"},[a("div",{staticClass:"chat-top"},[a("img",{attrs:{src:s("03a8")},on:{click:function(t){return e.$router.back()}}}),a("div",{directives:[{name:"show",rawName:"v-show",value:e.mensajesNoLeidos>0,expression:"mensajesNoLeidos > 0"}],staticClass:"chat-mobile-noLeidos",on:{click:function(t){return e.$router.back()}}},[e._v(e._s(e.mensajesNoLeidos))]),a("p",{on:{click:function(t){return e.$router.back()}}},[e._v(" "+e._s(null!=e.$conversacionElegida?e.$conversacionElegida.user_dest.name:"")+" ")])]),a("div",{ref:"chatScroll",staticClass:"chat-scroll",attrs:{id:"chatScroll"},on:{scroll:e.onScroll}},e._l(e.mensajes,(function(t){return a("div",{key:t.id,staticClass:"chat-container",class:{"chat-mensaje-propio":t.sender_id==e.userId},attrs:{id:t.id}},[null!=t.fecha?a("div",{staticClass:"chat-separador"},[a("label",[e._v(e._s(t.fecha))])]):e._e(),null==t.fecha?a("div",[t.sender_id!=e.userId?a("span",{staticClass:"chat-tail"},[a("svg",{staticStyle:{display:"block"},attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 8 13",width:"8",height:"13"}},[a("path",{attrs:{opacity:".13",fill:"#0000000",d:"M1.533 3.568L8 12.193V1H2.812C1.042 1 .474 2.156 1.533 3.568z"}}),a("path",{attrs:{fill:"currentColor",d:"M1.533 2.568L8 11.193V0H2.812C1.042 0 .474 1.156 1.533 2.568z"}})])]):e._e(),t.sender_id==e.userId?a("span",{staticClass:"chat-tail-out"},[a("svg",{staticClass:"chat-tail-svg",staticStyle:{display:"block"},attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 8 13",width:"8",height:"13"}},[a("path",{attrs:{opacity:".13",d:"M5.188 1H0v11.193l6.467-8.625C7.526 2.156 6.958 1 5.188 1z"}}),a("path",{attrs:{fill:"currentColor",d:"M5.188 0H0v11.193l6.467-8.625C7.526 1.156 6.958 0 5.188 0z"}})])]):e._e(),null!=t.message_type&&"TextMessage"==t.message_type.substr(11,100)?a("MensajeTexto",{attrs:{mensaje:t}}):e._e(),null!=t.message_type&&"PositionMessage"==t.message_type.substr(11,100)?a("MensajePosicion",{attrs:{mensaje:t}}):e._e(),null!=t.message_type&&"FileMessage"==t.message_type.substr(11,100)&&e.esArchivo(t)?a("MensajeArchivo",{attrs:{mensaje:t}}):e._e(),null!=t.message_type&&"FileMessage"==t.message_type.substr(11,100)&&e.esImagen(t)?a("MensajeImagen",{attrs:{mensaje:t}}):e._e(),null!=t.message_type&&"FileMessage"==t.message_type.substr(11,100)&&e.esVideo(t)?a("MensajeVideo",{attrs:{mensaje:t}}):e._e(),null!=t.message_type&&"FileMessage"==t.message_type.substr(11,100)&&e.esAudio(t)?a("MensajeAudio",{attrs:{mensaje:t}}):e._e()],1):e._e()])})),0),a("div",{staticClass:"chat-bottom"},[a("div",{staticClass:"chat-adjuntar",attrs:{title:"Adjuntar"}},[a("img",{attrs:{src:s("57bf")},on:{click:function(t){e.mostrarOpciones=!0}}})]),a("input",{ref:"inputTexto",attrs:{type:"text",placeholder:"Escribe un mensaje aquí",maxlength:"140"},on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.enviar()}}}),a("img",{directives:[{name:"show",rawName:"v-show",value:!e.enviando,expression:"!enviando"}],staticClass:"chat-enviar",attrs:{src:s("4556")},on:{click:function(t){return e.enviar()}}}),a("img",{directives:[{name:"show",rawName:"v-show",value:e.enviando,expression:"enviando"}],staticClass:"chat-enviar",staticStyle:{opacity:"0.5"},attrs:{src:s("4556")}})]),a("div",{directives:[{name:"show",rawName:"v-show",value:e.mostrarOpciones,expression:"mostrarOpciones"}],staticClass:"chat-opciones"},[a("div",{staticClass:"chat-opciones-mask",on:{click:function(t){e.mostrarOpciones=!1}}}),a("div",{staticClass:"chat-opciones-container"},[a("div",[a("input",{ref:"adjuntoFiles",staticClass:"app-hide",attrs:{type:"file",multiple:""},on:{change:function(t){return e.changeAdjunto()}}}),a("img",{staticClass:"chat-opciones-img",attrs:{src:s("57bf")},on:{click:function(t){return e.adjuntar()}}})]),a("div",[a("img",{staticClass:"chat-opciones-img",attrs:{src:s("b95f")},on:{click:function(t){return e.enviarPosicion()}}})])])])])])]),a("Loading",{directives:[{name:"show",rawName:"v-show",value:e.mostrarLoading,expression:"mostrarLoading"}]})],1)},n=[],o=(s("99af"),s("4de4"),s("4160"),s("caad"),s("45fc"),s("a434"),s("ac1f"),s("1276"),s("159b"),s("b620")),i=s("901b"),r=s("8a60"),c=s("b1af"),l=s("ff3b"),u=s("12e2"),h=s("5638"),d=s("3a5e");window.Pusher=s("782e");var m={name:"Chat",components:{MensajeTexto:o["a"],MensajeArchivo:i["a"],MensajeImagen:r["a"],MensajeVideo:c["a"],MensajeAudio:l["a"],MensajePosicion:u["a"],Loading:d["a"]},data:function(){return{mensajes:[],userId:null,primeraPagina:!0,currentPage:0,lastPage:0,mensajeOffset:null,mostrarLoading:!1,enviando:!1,mensajesNoLeidos:0,mostrarOpciones:!1}},props:{},computed:{},mounted:function(){this.mostrarLoading=!0,this.userId=localStorage.getItem("$userId"),this.getChat(),this.mensajes=[],this.$refs.chatScroll.addEventListener("touchmove",this.onScroll);var e=this;window.Echo=new h["a"]({broadcaster:"pusher",key:"ASDASD2121",wsHost:"23.237.173.86",wsPort:6001,disableStats:!0,forceTLS:!1,enabledTransports:["ws"]}),console.log("Conectando al websocket canal: user."+localStorage.getItem("$userId")),window.Echo.channel("user."+localStorage.getItem("$userId")).listen("NewMessage",(function(t){console.log("Recibo mensaje por websocket"),console.log(t),e.getChat()}))},created:function(){var e=this;this.$eventHub.$on("chat-get",(function(t){return e.onGetChat(t)}))},methods:{desconectarSocket:function(){window.Echo.channel("user."+localStorage.getItem("$userId")).stopListening("NewMessage")},esImagen:function(e){var t=e.message.files[0].file.split(".")[e.message.files[0].file.split(".").length-1].toLowerCase();return"png"==t||"jpg"==t||"svg"==t||"jpeg"==t},esVideo:function(e){var t=e.message.files[0].file.split(".")[e.message.files[0].file.split(".").length-1].toLowerCase();return"webm"==t||"mkv"==t||"flv"==t||"mp4"==t||"mov"==t||"avi"==t},esAudio:function(e){var t=e.message.files[0].file.split(".")[e.message.files[0].file.split(".").length-1].toLowerCase();return"m4a"==t||"qt"==t||"4mb"==t},esArchivo:function(e){return 0==this.esImagen(e)&&0==this.esVideo(e)&&0==this.esAudio(e)},onGetChat:function(e){null!=e&&(this.mostrarLoading=!0),this.getChat(e)},getChat:function(e){null==e?e=this.$route.params.id:(this.mensajes=[],this.primeraPagina=!0);var t=this;this.$axios.get(this.$localurl+"/api/v1/messages/"+e).then((function(e){t.mostrarLoading=!1,1!=t.primeraPagina||t.isOverflown(document.getElementById("chatScroll"))||(t.primeraPagina=!1,t.getChatPage(2));var s=!1;t.lastPage=e.data.messages.last_page,e.data.messages.data.reverse(),e.data.messages.data.forEach((function(e){t.mensajes.some((function(t){return t.id==e.id}))||e.conversation_id!=t.$route.params.id||(t.mensajes.push(e),s=!0)})),1==s&&(t.mensajeOffset=t.mensajes[t.mensajes.length-1]),t.getSeparadores()})).catch((function(e){t.mostrarLoading=!1,null!=e&&null!=e.response&&401==e.response.status&&(localStorage.removeItem("$expire"),localStorage.removeItem("$userId"),"login"!=window.location.pathname.split("/").reverse()[0]&&(t.desconectarSocket(),t.$router.push("/login")))}))},getChatPage:function(e){this.mensajeOffset=this.mensajes[0],null!=this.mensajeOffset&&null==this.mensajeOffset.id&&(this.mensajeOffset=this.mensajes[1]),this.currentPage=e;var t="";null!=e&&(t="?page="+e);var s=this;this.$axios.get(this.$localurl+"/api/v1/messages/"+this.$route.params.id+t).then((function(e){s.mostrarLoading=!1,e.data.messages.data.reverse(),s.mensajes=e.data.messages.data.concat(s.mensajes),s.getSeparadores()})).catch((function(e){s.mostrarLoading=!1,null!=e&&null!=e.response&&401==e.response.status&&(localStorage.removeItem("$expire"),"login"!=window.location.pathname.split("/").reverse()[0]&&(s.desconectarSocket(),s.$router.push("/login")))}))},getSeparadores:function(){var e=this,t=[];this.mensajes=this.mensajes.filter((function(e){return null==e.fecha}));for(var s=this.mensajes.length,a=0;a<s;a++){var n,o,i,r=this.mensajes[a];if(null!=r.created_at)(function(){n=new Date(r.created_at),n.setHours(n.getHours()+3);var c=n.getDate(),l=n.getMonth()+1,u=n.getFullYear(),h=c+"/"+l+"/"+u;o=new Date;var d=o.getDate(),m=o.getMonth()+1,g=o.getFullYear();c!=d||l!=m||u!=g?0==t.includes(h)&&(i=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"],h=i[n.getDay()]+" "+h,t.push(h),e.mensajes.some((function(e){return e.fecha==h}))||(e.mensajes.splice(a,0,{fecha:h}),s++)):e.mensajes.some((function(e){return"HOY"==e.fecha}))||(e.mensajes.splice(a,0,{fecha:"HOY"}),s++)})()}var c=this;this.$nextTick((function(){c.scrollToBottom()}))},getConversaciones:function(){var e=this;this.$axios.get(this.$localurl+"/api/v1/messages").then((function(t){e.mensajesNoLeidos=0,t.data.conversations.forEach((function(t){t.id!=e.$route.params.id&&(e.mensajesNoLeidos=e.mensajesNoLeidos+t.ammount_no_read)}))})).catch((function(){}))},onScroll:function(){var e=this.$refs.chatScroll;e.scrollTop<.1*e.clientHeight&&this.currentPage<this.lastPage&&(this.offset=this.offset+this.limit,this.currentPage++,this.getChatPage(this.currentPage))},scrollToBottom:function(){var e=this;this.$nextTick((function(){null!=e.mensajeOffset&&(null!=document.getElementById(e.mensajeOffset.id)?document.getElementById("chatScroll").scrollTop=document.getElementById(e.mensajeOffset.id).offsetTop:setTimeout((function(){e.scrollToBottom()}),200))}))},enviar:function(){if(0==this.enviando){this.enviando=!0,this.scrollToBottom();var e=this.$refs.inputTexto.value;if(""!=e){this.$refs.inputTexto.value="";var t=new FormData;t.append("message",e),t.append("receiver_id",this.$route.params.user_dest_id);var s=this;this.$axios.post(this.$localurl+"/api/v1/messages/textMessage",t).then((function(){s.enviando=!1,s.getChat()})).catch((function(e){s.enviando=!1,null!=e&&null!=e.response&&401==e.response.status&&(localStorage.removeItem("$expire"),localStorage.removeItem("$userId"),"login"!=window.location.pathname.split("/").reverse()[0]&&s.$router.push("/login")),alert("Se produjo un error, reintente")}))}}},isOverflown:function(e){return e.scrollHeight>e.clientHeight||e.scrollWidth>e.clientWidth},adjuntar:function(){this.$refs.adjuntoFiles.click()},changeAdjunto:function(){if(this.$refs.adjuntoFiles.files.length>0){var e=new FormData;e.append("message","archivos"),e.append("receiver_id",this.$route.params.user_dest_id),this.$refs.adjuntoFiles.files.forEach((function(t,s){e.append("file["+s+"]",t)}));var t=this;this.$axios.post(this.$localurl+"/api/v1/messages/fileMessage",e).then((function(){t.getChat()})).catch((function(e){null!=e&&null!=e.response&&401==e.response.status&&(localStorage.removeItem("$expire"),localStorage.removeItem("$userId"),"login"!=window.location.pathname.split("/").reverse()[0]&&(t.desconectarSocket(),t.$router.push("/login"))),alert("Se produjo un error, reintente")}))}},logout:function(){var e=this;this.$axios.post(this.$localurl+"/api/v1/auth/logout").then((function(){e.desconectarSSE(),localStorage.removeItem("$token"),localStorage.removeItem("$userId"),localStorage.removeItem("$expire"),"login"!=window.location.pathname.split("/").reverse()[0]&&e.$router.push("/login")})).catch((function(e){console.log(e)}))},enviarPosicion:function(){var e=this;this.mostrarOpciones=!1,navigator.geolocation.getCurrentPosition((function(t){e.enviando=!0;var s=new FormData;s.append("lat",t.coords.latitude),s.append("lon",t.coords.longitude),s.append("alt",null!=t.coords.altitude?t.coords.altitude:0),s.append("receiver_id",e.$route.params.user_dest_id),e.$axios.post(e.$localurl+"/api/v1/messages/positionMessage",s).then((function(){e.enviando=!1,e.getChat()})).catch((function(t){e.enviando=!1,null!=t&&null!=t.response&&401==t.response.status&&(console.log("desconecto socket"),e.$eventHub.$emit("home-desconectar-socket"),localStorage.removeItem("$expire"),localStorage.removeItem("$userId"),"login"!=window.location.pathname.split("/").reverse()[0]&&e.$router.push("/login")),alert("Se produjo un error, reintente")}))}))}}},g=m,p=(s("e3bf"),s("76cc"),s("2877")),f=Object(p["a"])(g,a,n,!1,null,"1ee42028",null);t["default"]=f.exports},"76cc":function(e,t,s){"use strict";var a=s("002d"),n=s.n(a);n.a},e3bf:function(e,t,s){"use strict";var a=s("faf0"),n=s.n(a);n.a},faf0:function(e,t,s){}}]);
//# sourceMappingURL=chat.2d166134.js.map